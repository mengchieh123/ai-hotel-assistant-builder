const express = require('express');
const cors = require('cors');
const app = express();
const PORT = process.env.PORT || 8080;

app.use(cors());
app.use(express.json());

console.log('🚀 啟動 AI 訂房助理服務...');

// 導入服務模組
let bookingService, pricingService, memberService, chatService;

try {
  chatService = require('./services/chatService');
  console.log('✅ chatService 導入成功');
} catch (error) {
  console.log('❌ chatService 導入失敗:', error.message);
}

try {
  bookingService = require('./services/bookingService');
  console.log('✅ bookingService 導入成功');
} catch (error) {
  console.log('🔄 使用內建 bookingService');
  bookingService = {
    async createBooking(bookingData) {
      return { success: true, bookingId: 'BKG-' + Date.now() };
    }
  };
}

try {
  pricingService = require('./services/pricingService');
  console.log('✅ pricingService 導入成功');
} catch (error) {
  console.log('🔄 使用內建 pricingService');
  pricingService = {
    calculateRoomPrice(roomType, nights, guestCount, memberLevel = 'none') {
      const rates = { standard: 2200, deluxe: 2800, suite: 4500 };
      const basePrice = (rates[roomType] || rates.standard) * nights;
      return { success: true, pricing: { basePrice, totalPrice: basePrice, currency: 'TWD' } };
    },
    applyPromotion(pricing, promoCode) {
      return { success: true, pricing: { ...pricing, finalPrice: pricing.totalPrice } };
    }
  };
}

try {
  memberService = require('./services/memberService');
  console.log('✅ memberService 導入成功');
} catch (error) {
  console.log('🔄 使用內建 memberService');
  memberService = {
    async calculatePoints(amount) {
      return { success: true, points: Math.floor(amount / 100) };
    }
  };
}

// 使用导入的智能 chatService
if (chatService) {
  app.use('/chat', chatService);
  console.log('✅ 智能 chatService 已启用');
} else {
  console.log('❌ 使用备用聊天服务');
  // 备用简单聊天服务
  app.post('/chat', (req, res) => {
    res.json({ 
      response: "聊天服务暂不可用",
      requirements: { symbolCount: 0, accessible: false, vegetarian: false }
    });
  });
}

// 會話暫存接口（用于其他API）
const sessions = new Map();

function getOrCreateSession(sessionId) {
  if (!sessions.has(sessionId)) {
    sessions.set(sessionId, { step: 'init', data: {} });
  }
  return sessions.get(sessionId);
}

// 健康檢查
app.get('/health', (req, res) => {
  res.json({ 
    status: 'healthy', 
    service: 'AI Hotel Assistant', 
    version: '5.5.0',
    chatService: chatService ? '智能版 v3.0' : '备用版'
  });
});

// 會話狀態統計
app.get('/api/sessions/stats', (req, res) => {
  res.json({ success: true, stats: { totalSessions: sessions.size, activeSessions: sessions.size } });
});

// 傳統訂房API
app.post('/api/booking', async (req, res) => {
  try {
    const { checkInDate, nights, roomType, guestCount = 1, guestName, memberLevel, promoCode } = req.body;
    if (!checkInDate || !nights || !roomType) return res.status(400).json({ success: false, message: '缺少必要資訊' });

    const price = pricingService.calculateRoomPrice(roomType, nights, guestCount, memberLevel);
    const promo = pricingService.applyPromotion(price.pricing, promoCode);
    const booking = await bookingService.createBooking(req.body);

    res.json({
      success: true,
      message: '訂房成功！',
      bookingReference: booking.bookingId,
      bookingDetails: { checkIn: checkInDate, nights, roomType, guests: guestCount },
      pricing: promo.pricing,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    res.status(500).json({ success: false, message: '訂房處理失敗', error: error.message });
  }
});

app.listen(PORT, () => console.log(`服務已啟動，監聽端口 ${PORT}`));
