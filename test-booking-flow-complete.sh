#!/bin/bash

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🧪 訂房流程業務邏輯完整測試"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "測試目標：驗證系統是否符合 business-spec.yaml v2.0-tw"
echo ""

BASE_URL="https://ai-hotel-assistant-builder-production.up.railway.app"
API_ENDPOINT="${BASE_URL}/api/ai/chat"

TOTAL_TESTS=0
PASSED_TESTS=0
FAILED_TESTS=0

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# 測試函數
test_chat() {
    local test_name="$1"
    local message="$2"
    local expected_keyword="$3"
    
    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo -e "${BLUE}測試 ${TOTAL_TESTS}: ${test_name}${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "📤 發送: ${message}"
    
    response=$(curl -s -X POST "${API_ENDPOINT}" \
        -H "Content-Type: application/json" \
        -d "{\"message\": \"${message}\", \"sessionId\": \"test-${TOTAL_TESTS}\"}" \
        --max-time 10)
    
    echo "📥 回應:"
    echo "${response}" | jq -r '.message' 2>/dev/null || echo "${response}"
    
    if echo "${response}" | grep -qi "${expected_keyword}"; then
        echo -e "${GREEN}✅ 通過${NC}"
        PASSED_TESTS=$((PASSED_TESTS + 1))
    else
        echo -e "${RED}❌ 失敗 - 未找到關鍵字: ${expected_keyword}${NC}"
        FAILED_TESTS=$((FAILED_TESTS + 1))
    fi
    
    sleep 0.5
}

echo ""
echo "🏁 開始測試..."
echo ""

# ============================================
# 測試組 1: 基本對話場景 (5項)
# ============================================
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📋 測試組 1: 基本對話場景"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

test_chat "問候場景" "你好" "歡迎"
test_chat "房型查詢" "有什麼房型" "房型"
test_chat "價格查詢" "豪華客房多少錢" "3800"
test_chat "設施查詢" "有什麼設施" "設施"
test_chat "早餐查詢" "有早餐嗎" "早餐"

# ============================================
# 測試組 2: 訂房流程 (4項)
# ============================================
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📋 測試組 2: 訂房流程"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

test_chat "訂房意圖" "我要訂房" "預訂"
test_chat "房型選擇" "我想訂豪華客房" "豪華"
test_chat "日期查詢" "12月25號有房嗎" "入住"
test_chat "人數確認" "2大1小可以嗎" "大人"

# ============================================
# 測試組 3: 價格與優惠 (5項)
# ============================================
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📋 測試組 3: 價格與優惠"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

test_chat "基礎房價" "房價多少" "3800"
test_chat "連住折扣" "住3晚有折扣嗎" "折扣"
test_chat "早鳥優惠" "提前訂有優惠嗎" "早鳥"
test_chat "優惠活動" "有什麼優惠" "優惠"
test_chat "官網直訂" "官網訂房有優惠嗎" "官網"

# ============================================
# 測試組 4: 會員體系 (5項)
# ============================================
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📋 測試組 4: 會員體系"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

test_chat "會員制度" "有會員嗎" "會員"
test_chat "會員等級" "會員有哪些等級" "銀卡"
test_chat "會員折扣" "會員有折扣嗎" "折扣"
test_chat "積分規則" "如何累積積分" "積分"
test_chat "生日優惠" "生日有優惠嗎" "生日"

# ============================================
# 測試組 5: 取消與修改政策 (4項)
# ============================================
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📋 測試組 5: 取消與修改政策"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

test_chat "取消政策" "取消政策是什麼" "24小時"
test_chat "免費取消" "什麼時候可以免費取消" "24小時"
test_chat "退款說明" "取消退款多少" "退款"
test_chat "不可退款" "不可退款房型" "不可退款"

# ============================================
# 測試組 6: 兒童與家庭政策 (4項)
# ============================================
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📋 測試組 6: 兒童與家庭政策"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

test_chat "兒童年齡" "兒童怎麼算" "6歲"
test_chat "兒童費用" "小孩要錢嗎" "免費"
test_chat "兒童設施" "有兒童設施嗎" "兒童"
test_chat "家庭套房" "家庭套房多少錢" "6800"

# ============================================
# 測試組 7: 入退房規則 (4項)
# ============================================
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📋 測試組 7: 入退房規則"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

test_chat "入住時間" "幾點可以入住" "15:00"
test_chat "退房時間" "幾點退房" "11:00"
test_chat "提早入住" "可以提早入住嗎" "提早"
test_chat "延遲退房" "可以延後退房嗎" "延遲"

# ============================================
# 測試組 8: 台灣特色功能 (5項)
# ============================================
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📋 測試組 8: 台灣特色功能"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

test_chat "LINE Pay" "可以用LINE Pay嗎" "LINE"
test_chat "超商繳費" "可以超商付款嗎" "超商"
test_chat "國旅券" "可以用國旅券嗎" "國旅券"
test_chat "信用卡分期" "可以分期付款嗎" "分期"
test_chat "颱風政策" "颱風可以取消嗎" "颱風"

# ============================================
# 測試組 9: 設施與服務 (4項)
# ============================================
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📋 測試組 9: 設施與服務"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

test_chat "設施列表" "有哪些設施" "游泳池"
test_chat "停車服務" "有停車場嗎" "停車"
test_chat "交通資訊" "怎麼去飯店" "交通"
test_chat "早餐時間" "早餐幾點開始" "06:30"

# ============================================
# 測試組 10: 複雜場景 (5項)
# ============================================
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📋 測試組 10: 複雜場景"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

test_chat "多條件查詢" "2大1小住3晚多少錢" "價格"
test_chat "會員+早鳥" "我是會員，提前60天訂有折扣嗎" "折扣"
test_chat "完整訂房" "我要訂豪華客房，12/25入住2晚" "訂房"
test_chat "優惠疊加" "連住折扣可以跟會員折扣疊加嗎" "折扣"
test_chat "政府補助" "怎麼使用國旅券" "國旅券"

# ============================================
# 測試結果統計
# ============================================
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📊 測試結果統計"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "總測試數: ${TOTAL_TESTS}"
echo -e "${GREEN}✅ 通過: ${PASSED_TESTS}${NC}"
echo -e "${RED}❌ 失敗: ${FAILED_TESTS}${NC}"
echo ""

if [ ${TOTAL_TESTS} -gt 0 ]; then
    pass_rate=$((PASSED_TESTS * 100 / TOTAL_TESTS))
    echo "通過率: ${pass_rate}%"
    echo ""
    
    if [ ${pass_rate} -ge 90 ]; then
        echo -e "${GREEN}🎉 優秀！系統運行良好，完全符合 business-spec.yaml 規格${NC}"
    elif [ ${pass_rate} -ge 70 ]; then
        echo -e "${YELLOW}⚠️ 良好，但仍有改進空間${NC}"
    elif [ ${pass_rate} -ge 50 ]; then
        echo -e "${YELLOW}⚠️ 及格，需要優化多項功能${NC}"
    else
        echo -e "${RED}❌ 系統需要大幅優化${NC}"
    fi
fi

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "📋 測試摘要"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "測試時間: $(date '+%Y-%m-%d %H:%M:%S')"
echo "測試環境: Railway Production"
echo "API 端點: ${API_ENDPOINT}"
echo ""
echo "測試組別:"
echo "  1. 基本對話場景 (5項)"
echo "  2. 訂房流程 (4項)"
echo "  3. 價格與優惠 (5項)"
echo "  4. 會員體系 (5項)"
echo "  5. 取消與修改政策 (4項)"
echo "  6. 兒童與家庭政策 (4項)"
echo "  7. 入退房規則 (4項)"
echo "  8. 台灣特色功能 (5項)"
echo "  9. 設施與服務 (4項)"
echo "  10. 複雜場景 (5項)"
echo ""
echo "總計: ${TOTAL_TESTS} 個測試案例"
echo ""

if [ ${pass_rate} -lt 80 ]; then
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "🔧 改進建議"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "1. 檢查 services/mock-ai-service.js"
    echo "   → 意圖識別關鍵字是否完整"
    echo ""
    echo "2. 檢查回覆模板"
    echo "   → 確保包含預期關鍵字"
    echo ""
    echo "3. 更新 conversation-spec.yaml"
    echo "   → 補充缺失的對話場景"
    echo ""
fi

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✅ 測試完成"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

