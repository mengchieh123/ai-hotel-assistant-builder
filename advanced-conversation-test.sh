#!/bin/bash

API="https://ai-hotel-assistant-builder-production.up.railway.app"

echo "🎯 AI 訂房助理 - 進階對話能力測試"
echo "=========================================="
echo "測試複雜、多層次的真實場景"
echo ""

# 進階測試函數
test_advanced() {
    local number=$1
    local scenario=$2
    local message=$3
    local expected_keywords=$4
    
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "🧪 測試 $number: $scenario"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "👤 用戶查詢:"
    echo "   $message"
    echo ""
    
    RESPONSE=$(curl -s -X POST "$API/api/ai/chat" \
      -H "Content-Type: application/json" \
      -d "{\"message\":\"$message\"}")
    
    if [ $? -eq 0 ] && [ -n "$RESPONSE" ]; then
        INTENT=$(echo "$RESPONSE" | jq -r '.intent' 2>/dev/null)
        MESSAGE=$(echo "$RESPONSE" | jq -r '.message' 2>/dev/null)
        
        echo "🤖 AI 回應 (意圖: $INTENT):"
        echo "$MESSAGE"
        echo ""
        
        # 檢查關鍵回應內容
        echo "📋 內容檢查:"
        
        IFS='|' read -ra KEYWORDS <<< "$expected_keywords"
        for keyword in "${KEYWORDS[@]}"; do
            if echo "$MESSAGE" | grep -qi "$keyword"; then
                echo "   ✅ 包含關鍵字: $keyword"
            else
                echo "   ❌ 缺少關鍵字: $keyword"
            fi
        done
        
        # 評估回應質量
        CHAR_COUNT=$(echo "$MESSAGE" | wc -c)
        if [ $CHAR_COUNT -gt 100 ]; then
            echo "   ✅ 回應詳細度: 充足 (${CHAR_COUNT} 字元)"
        else
            echo "   ⚠️  回應詳細度: 不足 (${CHAR_COUNT} 字元)"
        fi
        
    else
        echo "   ❌ API 請求失敗"
    fi
    
    echo ""
    sleep 2
}

# ═══════════════════════════════════════════
# 進階測試場景
# ═══════════════════════════════════════════

# 測試 1: 複雜訂房需求（你的範例）
test_advanced "1" "複雜訂房需求 + 會員優惠 + 兒童政策" \
"我要訂台北市高級房間，預計12月24號入住，共3晚，我是會員。有沒有優惠價格或特殊套餐專案？另外小孩6歲可不可以同行？有沒有額外費用？" \
"12月|3晚|會員|優惠|小孩|6歲|費用"

# 測試 2: 多房型比較 + 預算限制
test_advanced "2" "多房型比較 + 預算考量" \
"我的預算大約是每晚5000元，想住3天2夜，請幫我比較豪華客房和行政客房的差別，哪個比較划算？另外這個價格包含早餐嗎？" \
"5000|3天2夜|豪華|行政|比較|早餐|包含"

# 測試 3: 特殊需求 + 設施詢問
test_advanced "3" "無障礙需求 + 特殊設施" \
"我爸爸行動不便需要輪椅，請問有無障礙房間嗎？房間裡有扶手嗎？另外飯店有電梯直達嗎？停車場離房間近嗎？" \
"輪椅|無障礙|扶手|電梯|停車"

# 測試 4: 長期住宿 + 商務需求
test_advanced "4" "長期商務住宿" \
"我需要長期出差住一個月，有沒有月租優惠？需要有書桌和高速網路，還要能開發票。另外可以每週更換床單嗎？" \
"一個月|月租|優惠|書桌|網路|發票|床單"

# 測試 5: 團體訂房 + 會議需求
test_advanced "5" "團體訂房 + 會議室" \
"我們公司要辦員工旅遊，大約15個人，需要5間雙人房，入住時間是3月15-17日。請問有團體優惠嗎？另外需要借用會議室2小時，費用怎麼算？" \
"15人|5間|雙人房|3月|團體|優惠|會議室|2小時"

# 測試 6: 寵物友善 + 特殊飲食
test_advanced "6" "寵物同行 + 素食需求" \
"我想帶我的小型犬（5公斤）一起入住，請問可以嗎？需要加收費用嗎？另外我吃素，早餐有素食選項嗎？" \
"小型犬|5公斤|寵物|費用|素食|早餐"

# 測試 7: 取消政策 + 改期需求
test_advanced "7" "取消與改期政策" \
"如果我訂了房間但臨時有事不能去，可以免費取消嗎？有期限限制嗎？如果改期的話需要加錢嗎？颱風天可以免費取消嗎？" \
"取消|期限|改期|加錢|颱風|免費"

# 測試 8: 生日慶祝 + 額外服務
test_advanced "8" "生日驚喜安排" \
"我想在12月24號帶女朋友來慶祝生日，可以幫忙佈置房間嗎？能準備蛋糕和花嗎？費用大概多少？另外晚餐有推薦的餐廳嗎？" \
"生日|12月24|佈置|蛋糕|花|費用|餐廳"

# 測試 9: 機場接送 + 行李寄存
test_advanced "9" "交通與行李服務" \
"我是晚上11點的飛機到桃園機場，有提供機場接送服務嗎？費用多少？另外我隔天中午12點退房但下午6點才要去機場，可以寄放行李嗎？" \
"11點|桃園機場|接送|費用|12點|退房|6點|行李|寄放"

# 測試 10: 多種需求組合
test_advanced "10" "綜合複雜需求" \
"我和太太帶兩個小孩（3歲和7歲）要住5天4夜，想要兩間相鄰的房間，需要嬰兒床，還要有浴缸。我們是銀卡會員，這樣總共多少錢？可以分期付款嗎？" \
"兩個小孩|3歲|7歲|5天4夜|兩間|相鄰|嬰兒床|浴缸|銀卡|會員|多少錢|分期"

echo "=========================================="
echo "✅ 進階對話測試完成"
echo "=========================================="
echo ""
echo "📊 測試總結："
echo "   • 測試場景: 10 個複雜真實情境"
echo "   • 涵蓋範圍: 複雜訂房、特殊需求、政策查詢、附加服務"
echo "   • 評估標準: 關鍵字識別、回應詳細度、意圖準確性"
echo ""
echo "💡 建議："
echo "   根據測試結果優化 AI 回應邏輯"
echo "   特別關注多條件查詢的處理能力"

