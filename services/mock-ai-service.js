// ============================================
// Mock AI Service v2.1.0
// 完全符合 business-spec.yaml v2.1.0-tw
// ============================================

class MockAIService {
  constructor() {
    this.sessionStore = new Map();
  }

  // ============================================
  // 意圖識別 - 15種意圖類型
  // ============================================
  detectIntent(message) {
    const msg = message.toLowerCase().trim();
    
    // 1. 問候
    if (/^(你好|嗨|哈囉|hi|hello|早安|午安|晚安)/.test(msg)) {
      return 'greeting';
    }
    
    // 2. 房型查詢
    if (/房型|房間種類|有什麼房|有哪些房|房間類型/.test(msg)) {
      return 'room_types';
    }
    
    // 3. 價格查詢
    if (/價格|多少錢|房價|價位|費用|收費/.test(msg)) {
      return 'price';
    }
    
    // 4. 訂房意圖
    if (/訂房|預訂|預約|我要訂|想訂|book/.test(msg)) {
      return 'booking';
    }
    
    // 5. 會員查詢
    if (/會員|會籍|積分|點數|等級|membership/.test(msg)) {
      return 'membership';
    }
    
    // 6. 取消政策
    if (/取消|退款|改期|不能去|cancel/.test(msg)) {
      return 'cancellation';
    }
    
    // 7. 兒童政策
    if (/小孩|兒童|嬰兒|幼兒|孩子|小朋友|kid|child/.test(msg)) {
      return 'children';
    }
    
    // 8. 入退房時間
    if (/入住|退房|check.*in|check.*out|幾點/.test(msg)) {
      return 'checkin';
    }
    
    // 9. 優惠活動
    if (/優惠|折扣|促銷|特價|活動|deal|promo/.test(msg)) {
      return 'promotions';
    }
    
    // 10. 付款方式
    if (/付款|支付|pay|LINE.*Pay|信用卡|超商|ATM|分期/.test(msg)) {
      return 'payment';
    }
    
    // 11. 設施查詢
    if (/設施|設備|服務|amenity|facility|游泳池|健身房/.test(msg)) {
      return 'facilities';
    }
    
    // 12. 早餐查詢
    if (/早餐|breakfast/.test(msg)) {
      return 'breakfast';
    }
    
    // 13. 停車查詢
    if (/停車|車位|parking/.test(msg)) {
      return 'parking';
    }
    
    // 14. 交通資訊
    if (/交通|怎麼去|接送|transport/.test(msg)) {
      return 'transportation';
    }
    
    // 15. 台灣特色 - 政府補助
    if (/國旅券|振興券|五倍券|政府補助/.test(msg)) {
      return 'taiwan_subsidy';
    }
    
    return 'unknown';
  }

  // ============================================
  // 回覆生成 - 符合 business-spec v2.1.0
  // ============================================
  generateResponse(intent, message) {
    const responses = {
      greeting: `🏨 歡迎光臨！我是您的訂房助理。

我可以協助您：
• 查詢房型與價格
• 了解會員制度與優惠
• 預訂房間
• 取消政策說明
• 兒童政策與家庭優惠
• 付款方式（LINE Pay、超商繳費等）

請問需要什麼協助？`,

      room_types: `🏨 **房型介紹**

**豪華客房** - NT$ 3,800/晚
• 2位大人 + 最多2位兒童（12歲以下）
• 房內最多3人（含加床）
• 舒適雙人床

**行政客房** - NT$ 4,800/晚
• 2位大人 + 最多2位兒童
• 房內最多3人（含加床）
• 含早餐、迎賓飲料

**家庭套房** - NT$ 6,800/晚
• 2大2小標準配置
• 房內最多4人
• 含早餐、兒童設施

**總統套房** - NT$ 12,800/晚
• 4位大人
• 頂級禮遇、含早餐

需要了解更多或預訂嗎？`,

      price: `💰 **房價資訊**

**基礎房價**
• 豪華客房：NT$ 3,800/晚
• 行政客房：NT$ 4,800/晚
• 家庭套房：NT$ 6,800/晚
• 總統套房：NT$ 12,800/晚

**連住優惠**
• 住2晚：95折
• 住3-4晚：90折
• 住5-6晚：85折
• 住7晚以上：80折

**早鳥優惠**
• 提前30天：85折
• 提前60天：80折
• 提前90天：75折
• 提前120天：70折

**會員折扣**
• 銀卡：5%
• 金卡：8%
• 白金：12%

**官網直訂最優惠，比OTA平台便宜5-10%！**`,

      booking: `📅 **開始預訂**

請提供以下資訊：
1. 入住日期（例：12/25）
2. 退房日期（例：12/27）
3. 房型選擇
4. 入住人數（大人+小孩）

或直接說明：
「我要訂豪華客房，12/25入住2晚，2大1小」

我會為您計算總價並協助完成預訂！`,

      membership: `💎 **會員制度**

**普通會員**（註冊即可）
• 無折扣
• 每NT$100=1點

**銀卡會員**
• 條件：入住5晚 或 消費NT$10,000
• 折扣：5%
• 積分：每NT$100=1.2點
• 權益：提前1小時入住、延遲1小時退房、迎賓水果

**金卡會員**
• 條件：入住15晚 或 消費NT$30,000
• 折扣：8%
• 積分：每NT$100=1.5點
• 權益：12:00入住、13:00退房、免費升等、迷你吧免費

**白金會員**
• 條件：入住30晚 或 消費NT$60,000
• 折扣：12%
• 積分：每NT$100=2點
• 權益：保證升等、免費機場接送、VIP禮遇

**生日優惠：當月入住享85折** 🎂`,

      cancellation: `❌ **取消政策**

**免費取消**
• 入住前24小時（含）取消
• 全額退款
• 處理時間：7-14個工作日

**部分退款**
• 入住前12-24小時取消
• 退款50%

**不可退款**
• 入住前12小時內
• 不可取消、不可退款

**特殊政策**
• 連假期間：入住前72小時不可取消
• 春節期間：入住前7天不可取消
• 天災條款：颱風/地震可彈性處理

**彈性取消方案**（加價10%）
• 入住前3小時仍可免費取消`,

      children: `👶 **兒童政策**

**年齡定義**
• 嬰兒：0-3歲
• 幼兒：4-6歲
• 兒童：7-12歲
• 青少年：13-17歲

**費用標準**
• 0-3歲：免費（提供嬰兒床）
• 4-6歲：免費（與大人同床）
  加床：NT$ 300/晚
• 7-12歲：加床 NT$ 500/晚（含早餐）
• 13歲以上：視同成人 NT$ 800/晚

**兒童設施**
• 兒童遊戲室（免費）
• 兒童戲水池
• 兒童餐具與座椅
• 嬰兒床、澡盆、消毒鍋（免費借用）

**暑假家庭專案**
• 2大2小入住家庭套房
• 第2位兒童免費！`,

      checkin: `🏨 **入退房時間**

**標準時間**
• 入住：15:00
• 退房：11:00

**會員禮遇**
• 銀卡：提前1小時入住、延遲1小時退房
• 金卡：12:00入住、13:00退房
• 白金：保證12:00入住、保證14:00退房

**提早入住**
• 14:00後免費（視房況）
• 12:00-15:00：半天房費

**延遲退房**
• 延遲1小時免費（視房況）
• 12:00-18:00：半天房費
• 18:00後：全天房費

**證件要求**
• 本國人：身分證、駕照或健保卡
• 外國人：護照
• 未滿18歲：需監護人陪同`,

      promotions: `🎉 **優惠活動**

**連住優惠**
• 2晚：95折
• 3-4晚：90折
• 5-6晚：85折
• 7晚以上：80折

**早鳥優惠**
• 30天前：85折
• 60天前：80折
• 90天前：75折

**官網直訂優惠**
• 比OTA便宜5-10%
• 額外贈送：早餐升級、迎賓飲料

**生日優惠** 🎂
• 當月入住：85折
• 生日蛋糕贈送

**會員折扣**
• 銀卡：5%
• 金卡：8%
• 白金：12%

**國旅券/振興券**
• 最高折抵NT$1,000/房/晚

**推薦獎勵**
• 推薦朋友獲得500積分`,

      payment: `💳 **付款方式**

**線上支付**
• 信用卡（Visa/Master/JCB/AE）
• LINE Pay（享3%回饋）✨
• 街口支付（享2%回饋）
• Apple Pay / Google Pay
• 台灣Pay

**超商代碼繳費** 🏪
• 7-11 ibon
• 全家 FamiPort
• 萊爾富 Life-ET
• OK 便利商店
• 3天內完成繳費

**ATM 轉帳**
• 虛擬帳號繳費
• 3天內完成轉帳

**現場付款**
• 信用卡
• 現金（新台幣）
• 行動支付

**分期付款**
• 滿NT$3,000：3期免息
• 滿NT$6,000：6期免息
• 滿NT$12,000：12期免息

**發票開立**
• 電子發票（可存載具）
• 三聯式發票（提供統編）`,

      taiwan_subsidy: `��🇼 **政府補助使用**

**國旅券**
• 最高折抵：NT$1,000/房/晚
• 使用限制：僅限官網訂房
• 核銷方式：入住時出示券號

**振興券 / 五倍券**
• 可線上使用或現場核銷
• 不可與其他優惠併用

**安心旅遊補助**
• 每房每晚最高折抵NT$1,000
• 符合政府規定之旅客
• 訂房時選擇補助方案

使用方式：訂房時告知使用補助券，我們會協助您申請！`,

      facilities: `🏊 **飯店設施**

**休閒設施**
• 室內游泳池
• 健身房（24小時）
• SPA 水療中心
• 兒童遊戲室

**餐飲服務**
• 自助式早餐（06:30-10:00）
• 全日餐廳
• 酒吧 / 咖啡廳

**商務服務**
• 商務中心
• 會議室
• 免費 WiFi

**其他服務**
• 24小時櫃檯
• 禮賓服務
• 洗衣服務
• 停車場（免費）`,

      breakfast: `🍳 **早餐資訊**

**費用**
• 成人：NT$ 450/人/天
• 兒童（7-12歲）：NT$ 250/人/天
• 6歲以下：免費

**包含早餐房型**
• 行政客房 ✓
• 家庭套房 ✓
• 總統套房 ✓

**供應時間**
• 06:30 - 10:00

**早餐內容**
• 中式熱食
• 西式麵包
• 新鮮水果
• 咖啡、果汁`,

      parking: `🚗 **停車資訊**

• 免費停車場
• 24小時開放
• 室內停車位
• 先到先停
• 電動車充電設施

入住時告知車牌號碼即可！`,

      transportation: `🚌 **交通資訊**

**機場接送**
• 白金會員：免費1趟（限雙北）
• 其他會員：優惠價NT$800

**大眾運輸**
• 捷運：XX站步行5分鐘
• 公車：多條路線可達

**自駕**
• 免費停車場
• 導航地址：XXX

**高鐵/火車站**
• 計程車約15分鐘
• 可預約接送服務`,

      unknown: `🤖 抱歉，我不太理解您的問題。

我可以協助您：
• 查詢「房型」和「價格」
• 「訂房」服務
• 「會員」制度說明
• 「取消」政策查詢
• 「兒童」政策與家庭優惠
• 「優惠」活動資訊
• 「付款」方式
• 「國旅券」使用

請問需要什麼協助？`
    };

    return {
      message: responses[intent] || responses.unknown,
      intent: intent,
      timestamp: new Date().toISOString()
    };
  }

  // ============================================
  // 主要處理函數
  // ============================================
  async processMessage(message, sessionId = 'default') {
    try {
      const intent = this.detectIntent(message);
      const response = this.generateResponse(intent, message);
      
      this.sessionStore.set(sessionId, {
        lastIntent: intent,
        lastMessage: message,
        timestamp: new Date().toISOString()
      });
      
      return response;
    } catch (error) {
      console.error('AI Service Error:', error);
      return {
        message: '❌ 抱歉，系統發生錯誤，請稍後再試。',
        intent: 'error',
        timestamp: new Date().toISOString()
      };
    }
  }
}

module.exports = new MockAIService();
